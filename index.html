<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Tracker</title>

    <!-- Materialize CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 95%;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .landing-layout {
            display: flex;
            gap: 0;
            margin: -30px;
        }

        .sidebar {
            width: 250px;
            background: #f5f5f5;
            border-right: 1px solid #e0e0e0;
            padding: 20px 0;
            min-height: 600px;
        }

        .sidebar-menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #666;
            font-size: 15px;
            border-left: 3px solid transparent;
        }

        .sidebar-menu-item:hover {
            background: #eeeeee;
            color: #333;
        }

        .sidebar-menu-item.active {
            background: white;
            color: #7c3aed;
            border-left-color: #7c3aed;
            font-weight: 500;
        }

        .sidebar-menu-item i {
            font-size: 20px;
        }

        .landing-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .landing-section {
            display: none;
        }

        .landing-section.active {
            display: block;
        }

        .session-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        table.striped tbody tr {
            transition: background-color 0.2s ease;
        }

        table.striped tbody tr:hover {
            background-color: #f5f5f5 !important;
        }

        table thead th {
            font-weight: 600;
            color: #424242;
        }

        table tbody td {
            padding: 12px 15px;
        }

        .session-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .session-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .session-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .session-card .session-meta {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .session-card .delete-session-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .session-card:hover .delete-session-btn {
            opacity: 1;
        }

        .session-card .delete-session-btn:hover {
            background: #c82333;
        }

        .dropdown-content {
            min-width: 220px !important;
        }

        .dropdown-content li > a {
            display: flex !important;
            align-items: center;
            color: #333 !important;
            padding: 14px 16px !important;
        }

        .dropdown-content li > a > i {
            margin-right: 10px;
        }

        .dropdown-content li > a.red-text:hover {
            background-color: #ffebee !important;
        }

        .new-session-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px dashed #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            color: white;
            font-size: 48px;
        }

        .new-session-card:hover {
            border-color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .back-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .available-events-panel {
            background: #f8f9fa;
            border: 2px solid #6c757d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .available-events-panel h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .event-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .event-btn {
            padding: 20px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            min-height: 100px;
        }

        .event-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .event-btn:active {
            transform: translateY(0);
        }

        .event-btn.meeting { background: #3b82f6; }
        .event-btn.break { background: #10b981; }
        .event-btn.task { background: #f59e0b; }
        .event-btn.phone { background: #ef4444; }
        .event-btn.email { background: #8b5cf6; }
        .event-btn.other { background: #ec4899; }

        .event-btn.active {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3), 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .event-btn-label {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .event-btn-status {
            font-size: 12px;
            font-weight: 500;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-btn-duration {
            font-size: 14px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            min-width: 80px;
            text-align: center;
        }

        .event-btn-instances {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .clear-btn {
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .clear-btn:hover {
            background: #b91c1c;
        }

        .csv-btn {
            padding: 10px 20px;
            background: #0891b2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .csv-btn:hover {
            background: #0e7490;
        }

        .reset-btn {
            padding: 10px 20px;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .reset-btn:hover {
            background: #ea580c;
        }

        .events-list {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .events-list h2 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .event-item {
            background: white;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .event-item.running {
            background: #e7f5ff;
        }

        .event-type {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .event-time {
            color: #666;
            font-size: 13px;
            text-align: right;
        }

        .event-duration {
            color: #28a745;
            font-weight: 600;
            font-size: 13px;
            margin-left: 10px;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-style: italic;
        }

        .event-types-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .event-type-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .event-type-item input[type="text"] {
            flex: 1;
            min-width: 150px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .event-type-item input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .event-type-item input[type="color"] {
            width: 60px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            background: white;
        }

        .event-type-item select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            min-width: 150px;
        }

        .event-type-item select:focus {
            outline: none;
            border-color: #667eea;
        }

        .complementary-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .event-type-item input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        .event-type-item input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        .delete-event-btn {
            padding: 8px 12px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .delete-event-btn:hover {
            background: #b91c1c;
        }

        .add-event-btn {
            padding: 10px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .add-event-btn:hover {
            background: #059669;
        }

        .save-settings-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .save-settings-btn:hover {
            background: #5568d3;
        }

        .settings-section h3 {
            color: #333;
            margin-bottom: 10px;
            margin-top: 20px;
            font-size: 16px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .settings-section h3:first-of-type {
            margin-top: 0;
        }



        .timeline-btn {
            padding: 10px 20px;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .timeline-btn:hover {
            background: #6d28d9;
        }

        .timeline-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .timeline-section.show {
            display: block;
        }

        .timeline-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .timeline-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .timeline-controls label {
            color: #666;
            font-size: 14px;
            font-weight: 600;
        }

        .timeline-controls input,
        .timeline-controls select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .download-timeline-btn {
            padding: 8px 16px;
            background: #059669;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
            margin-left: auto;
        }

        .download-timeline-btn:hover {
            background: #047857;
        }

        #timelineCanvas {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: crosshair;
        }

        .timeline-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .timeline-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-label {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .tabs {
            margin-bottom: 20px;
            background-color: transparent !important;
        }

        .tabs .tab {
            background-color: transparent !important;
        }

        .tabs .tab a {
            color: #9e9e9e !important;
            font-weight: 400;
            background-color: transparent !important;
        }

        .tabs .tab a:hover {
            color: #666 !important;
            background-color: transparent !important;
        }

        .tabs .tab a.active {
            color: #7c3aed !important;
            font-weight: 600;
            background-color: transparent !important;
        }

        .tabs .tab a:focus,
        .tabs .tab a:focus.active {
            background-color: transparent !important;
        }

        .tabs .indicator {
            background-color: #7c3aed !important;
            height: 3px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .settings-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
        }

        .settings-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .setting-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .setting-item h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .setting-item p {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .setting-item select {
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            max-width: 300px;
            cursor: pointer;
        }

        .setting-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Landing Page View -->
        <div id="landingView" class="view active">
            <div class="landing-layout">
                <!-- Sidebar Menu -->
                <div class="sidebar">
                    <div class="sidebar-menu-item active" onclick="switchLandingSection('sessions')">
                        <i class="material-icons">folder</i>
                        <span data-i18n="trackingSessions">Tracking Sessions</span>
                    </div>
                    <div class="sidebar-menu-item" onclick="switchLandingSection('eventTypes')">
                        <i class="material-icons">label</i>
                        <span data-i18n="eventTypes">Event Types</span>
                    </div>
                    <div class="sidebar-menu-item" onclick="switchLandingSection('settings')">
                        <i class="material-icons">settings</i>
                        <span data-i18n="globalSettings">Global Settings</span>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="landing-content">
                    <!-- Tracking Sessions Section -->
                    <div id="sessionsSection" class="landing-section active">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h4 class="grey-text text-darken-3" style="margin: 0;"><i class="material-icons left">folder</i><span data-i18n="trackingSessions">Tracking Sessions</span></h4>
                                <p class="grey-text" style="margin: 5px 0 0 0;" data-i18n="manageYourSessions">Manage your tracking sessions</p>
                            </div>
                            <button class="btn waves-effect waves-light deep-purple" onclick="createNewSession()">
                                <i class="material-icons left">add</i><span data-i18n="newSession">New Session</span>
                            </button>
                        </div>
                        <table class="striped highlight responsive-table">
                            <thead>
                                <tr>
                                    <th data-i18n="sessionName">Session Name</th>
                                    <th data-i18n="created">Created</th>
                                    <th data-i18n="lastModified">Last Modified</th>
                                    <th class="center-align" data-i18n="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sessionTableBody">
                                <!-- Sessions will be rendered here -->
                            </tbody>
                        </table>
                        <div id="emptySessionsMessage" style="display: none; text-align: center; padding: 60px 20px;">
                            <i class="material-icons grey-text" style="font-size: 64px;">folder_open</i>
                            <p class="grey-text" style="font-size: 18px; margin-top: 20px;" data-i18n="noSessionsYet">No tracking sessions yet</p>
                            <p class="grey-text" style="font-size: 14px;" data-i18n="createFirstSession">Click "New Session" to create your first tracking session</p>
                        </div>
                    </div>

                    <!-- Event Types Section -->
                    <div id="eventTypesSection" class="landing-section">
                        <h4 class="grey-text text-darken-3"><i class="material-icons left">label</i><span data-i18n="eventTypes">Event Types</span></h4>
                        <p class="grey-text" data-i18n="defineEventTypes">Define the types of events you want to track across all sessions</p>
                        <div class="event-types-list" id="globalEventTypesList" style="margin-top: 30px;"></div>
                        <button class="btn waves-effect waves-light deep-purple" onclick="addGlobalEventType()" style="margin-top: 20px;">
                            <i class="material-icons left">add</i><span data-i18n="addEventType">Add Event Type</span>
                        </button>
                    </div>

                    <!-- Global Settings Section -->
                    <div id="settingsSection" class="landing-section">
                        <h4 class="grey-text text-darken-3"><i class="material-icons left">settings</i><span data-i18n="globalSettings">Global Settings</span></h4>
                        <p class="grey-text" data-i18n="configureGlobalSettings">Configure global application settings</p>
                        <div style="margin-top: 30px;">
                            <h6>Language / Langue</h6>
                            <p class="grey-text" style="font-size: 14px; margin-bottom: 15px;">Select your preferred language / SÃ©lectionnez votre langue</p>
                            <div class="input-field">
                                <select id="globalLanguageSetting" onchange="saveGlobalLanguage()">
                                    <option value="en">English</option>
                                    <option value="fr">FranÃ§ais</option>
                                </select>
                                <label>Language / Langue</label>
                            </div>
                        </div>
                        <div style="margin-top: 30px;">
                            <h6 data-i18n="timelineTimeScale">Timeline Time Scale</h6>
                            <p class="grey-text" style="font-size: 14px; margin-bottom: 15px;" data-i18n="compressExpandTimeline">Compress or expand the timeline visualization</p>
                            <div class="input-field">
                                <select id="globalTimeScaleSetting" onchange="saveGlobalTimeScale()">
                                    <option value="1">1:1 (Real-time - 1 second = 1 second)</option>
                                    <option value="60">1:60 (1 minute = 1 second)</option>
                                    <option value="120">1:120 (2 minutes = 1 second)</option>
                                    <option value="300">1:300 (5 minutes = 1 second)</option>
                                    <option value="600">1:600 (10 minutes = 1 second)</option>
                                    <option value="1800">1:1800 (30 minutes = 1 second)</option>
                                    <option value="3600">1:3600 (1 hour = 1 second)</option>
                                </select>
                                <label data-i18n="selectTimeScale">Select Time Scale</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tracking View -->
        <div id="trackingView" class="view">
            <!-- Navigation Bar -->
            <div style="background: #7c3aed; color: white; padding: 15px 20px; margin: -30px -30px 30px -30px; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button type="button" class="btn waves-effect waves-light white deep-purple-text" onclick="backToLanding()" style="margin: 0;">
                        <i class="material-icons left">arrow_back</i><span data-i18n="sessions">Sessions</span>
                    </button>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;" data-i18n="currentSession">Current Session</div>
                        <div id="sessionTitle" style="font-size: 20px; font-weight: 500; margin-top: 2px;">Event Tracker</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="material-icons">folder_open</i>
                    <a class="dropdown-trigger btn-floating waves-effect waves-light white deep-purple-text" href="#!" data-target="sessionActionsDropdown" style="margin: 0;">
                        <i class="material-icons">settings</i>
                    </a>
                </div>
            </div>

            <p class="grey-text" data-i18n="startStopEvents">Start and stop events to track your activities</p>

            <ul class="tabs tabs-fixed-width">
                <li class="tab"><a href="#eventsTab" class="active" data-i18n="tracker">Tracker</a></li>
                <li class="tab"><a href="#timelineTab" data-i18n="timeline">Timeline</a></li>
                <li class="tab"><a href="#historyTab" data-i18n="history">History</a></li>
            </ul>

        <div id="eventsTab" class="tab-content active">
            <div class="available-events-panel">
                <h2 data-i18n="eventTrackerTitle">ðŸ“Š Event Tracker - Click to Start/Stop</h2>
                <div class="event-buttons" id="eventButtons">
                </div>
            </div>
        </div>

        <div id="historyTab" class="tab-content">
            <h5 class="grey-text text-darken-2" data-i18n="history">Event History</h5>
            <p class="grey-text">View all completed events</p>
            <table class="striped highlight responsive-table" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th data-i18n="eventType">Event Type</th>
                        <th data-i18n="startTime">Start Time</th>
                        <th data-i18n="endTime">End Time</th>
                        <th data-i18n="duration">Duration</th>
                        <th class="center-align" data-i18n="actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="eventsTableBody">
                    <!-- Events will be rendered here -->
                </tbody>
            </table>
            <div id="emptyEventsMessage" style="display: none; text-align: center; padding: 60px 20px;">
                <i class="material-icons grey-text" style="font-size: 64px;">event_note</i>
                <p class="grey-text" style="font-size: 18px; margin-top: 20px;" data-i18n="noEventsRecorded">No events recorded yet</p>
                <p class="grey-text" style="font-size: 14px;" data-i18n="startTracking">Start tracking events to see them here</p>
            </div>
        </div>

        <div id="timelineTab" class="tab-content">
            <div class="timeline-section show">
                <!-- Hidden inputs for internal use -->
                <input type="date" id="timelineDate" style="display: none;">
                <select id="timelineView" class="browser-default" style="display: none;">
                    <option value="day">Day View (24 hours)</option>
                    <option value="range">Date Range</option>
                </select>
                <input type="date" id="timelineEndDate" style="display: none;">

                <canvas id="timelineCanvas" style="width: 100%; display: block;"></canvas>
            </div>
        </div>

        </div>
        <!-- End of Tracking View -->
    </div>
    <!-- End of Container -->

    <div class="timeline-tooltip" id="timelineTooltip"></div>

    <!-- New Session Modal -->
    <div id="newSessionModal" class="modal">
        <div class="modal-content">
            <h4><i class="material-icons left">add</i><span data-i18n="newSession">Create New Session</span></h4>
            <p data-i18n="enterSessionName">Enter a name for your new tracking session</p>
            <div class="input-field">
                <input id="newSessionName" type="text" class="validate" onkeypress="if(event.key==='Enter') confirmCreateSession()" data-i18n="sessionName">
                <label for="newSessionName" data-i18n="sessionName">Session Name</label>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-light btn-flat" data-i18n="cancel">Cancel</a>
            <a href="#!" class="waves-effect waves-light btn deep-purple" onclick="confirmCreateSession()">
                <i class="material-icons left">check</i><span data-i18n="create">Create</span>
            </a>
        </div>
    </div>

    <!-- Session Actions Dropdown -->
    <ul id="sessionActionsDropdown" class="dropdown-content">
        <li><a href="#!" onclick="exportCSV()"><i class="material-icons left">file_download</i><span data-i18n="exportToCSV">Export to CSV</span></a></li>
        <li><a href="#!" onclick="downloadTimeline()"><i class="material-icons left">image</i><span data-i18n="exportTimelineImage">Export Timeline Image</span></a></li>
        <li class="divider"></li>
        <li><a href="#!" onclick="showResetConfirmationModal()" class="red-text"><i class="material-icons left red-text">delete_forever</i><span data-i18n="resetAllEvents">Reset All Events</span></a></li>
    </ul>

    <!-- Reset Confirmation Modal -->
    <div id="resetConfirmModal" class="modal">
        <div class="modal-content">
            <h4 style="color: #f44336;"><i class="material-icons left">warning</i><span data-i18n="resetAllEventsQuestion">Reset All Events?</span></h4>
            <p style="font-size: 16px;" data-i18n="resetWarning">This will stop all active events and permanently delete all event data for this session.</p>
            <p style="font-weight: 500; color: #f44336;" data-i18n="cannotBeUndone">This action cannot be undone!</p>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-light btn-flat" data-i18n="cancel">Cancel</a>
            <a href="#!" class="waves-effect waves-light btn red" onclick="confirmResetEventsModal()">
                <i class="material-icons left">delete_forever</i><span data-i18n="yesResetAll">Yes, Reset All</span>
            </a>
        </div>
    </div>

    <script>
        const SESSIONS_KEY = 'trackingSessions';
        const GLOBAL_SETTINGS_KEY = 'globalSettings';
        let currentSessionId = null;
        let updateInterval;

        const DEFAULT_EVENT_TYPES = [];

        const translations = {
            en: {
                sessions: 'Sessions',
                trackingSessions: 'Tracking Sessions',
                manageYourSessions: 'Manage your tracking sessions',
                newSession: 'New Session',
                settings: 'Settings',
                globalSettings: 'Global Settings',
                configureGlobalSettings: 'Configure global application settings',
                language: 'Language',
                selectLanguage: 'Select your preferred language',
                timelineTimeScale: 'Timeline Time Scale',
                compressExpandTimeline: 'Compress or expand the timeline visualization',
                selectTimeScale: 'Select Time Scale',
                sessionName: 'Session Name',
                enterSessionName: 'Enter session name',
                cancel: 'Cancel',
                create: 'Create',
                open: 'Open',
                delete: 'Delete',
                deleteSession: 'Delete Session',
                deleteSessionConfirm: 'Are you sure you want to delete this session?',
                noSessionsYet: 'No tracking sessions yet',
                createFirstSession: 'Click "New Session" to create your first tracking session',
                tracker: 'Tracker',
                timeline: 'Timeline',
                history: 'History',
                eventType: 'Event Type',
                eventTypes: 'Event Types',
                defineEventTypes: 'Define the types of events you want to track across all sessions',
                addEventType: 'Add Event Type',
                startTime: 'Start Time',
                endTime: 'End Time',
                duration: 'Duration',
                actions: 'Actions',
                created: 'Created',
                lastModified: 'Last Modified',
                noEventsRecorded: 'No events recorded yet',
                startTracking: 'Start tracking events to see them here',
                clickToStart: 'Click to Start',
                running: 'Running',
                no: 'No',
                eventTrackerTitle: 'Event Tracker - Click to Start/Stop',
                startStopEvents: 'Start and stop events to track your activities',
                currentSession: 'Current Session',
                exportToCSV: 'Export to CSV',
                exportTimelineImage: 'Export Timeline Image',
                resetAllEvents: 'Reset All Events',
                resetAllEventsQuestion: 'Reset All Events?',
                resetWarning: 'This will stop all active events and permanently delete all event data for this session.',
                cannotBeUndone: 'This action cannot be undone!',
                yesResetAll: 'Yes, Reset All',
                csvExported: 'CSV exported successfully!',
                timelineDownloaded: 'Timeline downloaded!',
                allEventsReset: 'All events have been reset!',
                timeScaleUpdated: 'Time scale updated!',
                languageUpdated: 'Language updated!',
                sessionCreated: 'Session created!',
                sessionDeleted: 'Session deleted!',
                noEventsToDisplay: 'No events to display in timeline!',
                noEventsFound: 'No events found for selected date/range',
                warningActiveEvents: 'Warning: You have active events running!',
                realTime: 'Real-time',
                second: 'second',
                seconds: 'seconds',
                minute: 'minute',
                minutes: 'minutes',
                hour: 'hour',
                hours: 'hours',
                eventName: 'Event Name',
                color: 'Color',
                complementaryEvent: 'Complementary Event',
                complementaryColor: 'Complementary Color',
                createsVariant: 'Creates a mutually exclusive variant',
                thisActionCannotBeUndone: 'This action cannot be undone.'
            },
            fr: {
                sessions: 'Sessions',
                trackingSessions: 'Sessions de Suivi',
                manageYourSessions: 'GÃ©rez vos sessions de suivi',
                newSession: 'Nouvelle Session',
                settings: 'ParamÃ¨tres',
                globalSettings: 'ParamÃ¨tres Globaux',
                configureGlobalSettings: 'Configurer les paramÃ¨tres globaux de l\'application',
                language: 'Langue',
                selectLanguage: 'SÃ©lectionnez votre langue',
                timelineTimeScale: 'Ã‰chelle de Temps',
                compressExpandTimeline: 'Compresser ou Ã©tendre la visualisation de la chronologie',
                selectTimeScale: 'SÃ©lectionner l\'Ã‰chelle de Temps',
                sessionName: 'Nom de la Session',
                enterSessionName: 'Entrez le nom de la session',
                cancel: 'Annuler',
                create: 'CrÃ©er',
                open: 'Ouvrir',
                delete: 'Supprimer',
                deleteSession: 'Supprimer la Session',
                deleteSessionConfirm: 'ÃŠtes-vous sÃ»r de vouloir supprimer cette session?',
                noSessionsYet: 'Aucune session de suivi pour le moment',
                createFirstSession: 'Cliquez sur "Nouvelle Session" pour crÃ©er votre premiÃ¨re session de suivi',
                tracker: 'Suivi',
                timeline: 'Chronologie',
                history: 'Historique',
                eventType: 'Type d\'Ã‰vÃ©nement',
                eventTypes: 'Types d\'Ã‰vÃ©nements',
                defineEventTypes: 'DÃ©finissez les types d\'Ã©vÃ©nements que vous souhaitez suivre dans toutes les sessions',
                addEventType: 'Ajouter un Type d\'Ã‰vÃ©nement',
                startTime: 'Heure de DÃ©but',
                endTime: 'Heure de Fin',
                duration: 'DurÃ©e',
                actions: 'Actions',
                created: 'CrÃ©Ã©',
                lastModified: 'DerniÃ¨re Modification',
                noEventsRecorded: 'Aucun Ã©vÃ©nement enregistrÃ©',
                startTracking: 'Commencez Ã  suivre des Ã©vÃ©nements pour les voir ici',
                clickToStart: 'Cliquez pour DÃ©marrer',
                running: 'En cours',
                no: 'Sans',
                eventTrackerTitle: 'Suivi d\'Ã‰vÃ©nements - Cliquez pour DÃ©marrer/ArrÃªter',
                startStopEvents: 'DÃ©marrez et arrÃªtez des Ã©vÃ©nements pour suivre vos activitÃ©s',
                currentSession: 'Session Actuelle',
                exportToCSV: 'Exporter en CSV',
                exportTimelineImage: 'Exporter l\'Image de la Chronologie',
                resetAllEvents: 'RÃ©initialiser Tous les Ã‰vÃ©nements',
                resetAllEventsQuestion: 'RÃ©initialiser Tous les Ã‰vÃ©nements?',
                resetWarning: 'Ceci arrÃªtera tous les Ã©vÃ©nements actifs et supprimera dÃ©finitivement toutes les donnÃ©es d\'Ã©vÃ©nements pour cette session.',
                cannotBeUndone: 'Cette action ne peut pas Ãªtre annulÃ©e!',
                yesResetAll: 'Oui, Tout RÃ©initialiser',
                csvExported: 'CSV exportÃ© avec succÃ¨s!',
                timelineDownloaded: 'Chronologie tÃ©lÃ©chargÃ©e!',
                allEventsReset: 'Tous les Ã©vÃ©nements ont Ã©tÃ© rÃ©initialisÃ©s!',
                timeScaleUpdated: 'Ã‰chelle de temps mise Ã  jour!',
                languageUpdated: 'Langue mise Ã  jour!',
                sessionCreated: 'Session crÃ©Ã©e!',
                sessionDeleted: 'Session supprimÃ©e!',
                noEventsToDisplay: 'Aucun Ã©vÃ©nement Ã  afficher dans la chronologie!',
                noEventsFound: 'Aucun Ã©vÃ©nement trouvÃ© pour la date/plage sÃ©lectionnÃ©e',
                warningActiveEvents: 'Attention: Vous avez des Ã©vÃ©nements actifs en cours!',
                realTime: 'Temps rÃ©el',
                second: 'seconde',
                seconds: 'secondes',
                minute: 'minute',
                minutes: 'minutes',
                hour: 'heure',
                hours: 'heures',
                eventName: 'Nom de l\'Ã‰vÃ©nement',
                color: 'Couleur',
                complementaryEvent: 'Ã‰vÃ©nement ComplÃ©mentaire',
                complementaryColor: 'Couleur ComplÃ©mentaire',
                createsVariant: 'CrÃ©e une variante mutuellement exclusive',
                thisActionCannotBeUndone: 'Cette action ne peut pas Ãªtre annulÃ©e.'
            }
        };

        function t(key) {
            const settings = getGlobalSettings();
            const lang = settings.language || 'en';
            return translations[lang][key] || translations.en[key] || key;
        }

        function updateUILanguage() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (element.tagName === 'INPUT' && element.placeholder !== undefined) {
                    element.placeholder = t(key);
                } else {
                    element.textContent = t(key);
                }
            });

            document.querySelectorAll('[data-i18n-html]').forEach(element => {
                const key = element.getAttribute('data-i18n-html');
                const icon = element.querySelector('i');
                const iconHtml = icon ? icon.outerHTML : '';
                element.innerHTML = iconHtml + t(key);
            });

            renderSessionList();
            if (currentSessionId) {
                renderEventButtons();
                displayEvents();
            }
        }

        function getSessions() {
            const data = localStorage.getItem(SESSIONS_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveSessions(sessions) {
            localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions));
        }

        function createSession(name) {
            const sessions = getSessions();
            const newSession = {
                id: 'session-' + Date.now(),
                name: name || 'Untitled Session',
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            sessions.push(newSession);
            saveSessions(sessions);
            return newSession;
        }

        function deleteSession(sessionId) {
            const sessions = getSessions().filter(s => s.id !== sessionId);
            saveSessions(sessions);
            localStorage.removeItem(sessionId + '-events');
            localStorage.removeItem(sessionId + '-activeEvents');
        }

        function updateSessionTimestamp(sessionId) {
            const sessions = getSessions();
            const session = sessions.find(s => s.id === sessionId);
            if (session) {
                session.lastModified = new Date().toISOString();
                saveSessions(sessions);
            }
        }

        function getSessionStorageKey(key) {
            return currentSessionId ? `${currentSessionId}-${key}` : key;
        }

        function detectBrowserLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith('fr')) {
                return 'fr';
            }
            return 'en';
        }

        function getGlobalSettings() {
            const data = localStorage.getItem(GLOBAL_SETTINGS_KEY);
            if (data) {
                return JSON.parse(data);
            }
            return {
                timeScale: 1,
                eventTypes: [],
                language: detectBrowserLanguage()
            };
        }

        function saveGlobalSettings(settings) {
            localStorage.setItem(GLOBAL_SETTINGS_KEY, JSON.stringify(settings));
        }

        function showLandingView() {
            document.getElementById('landingView').classList.add('active');
            document.getElementById('trackingView').classList.remove('active');
            currentSessionId = null;
            stopUpdateInterval();
            renderSessionList();
            renderGlobalEventTypes();
            loadGlobalSettings();
            switchLandingSection('sessions');
        }

        function switchLandingSection(sectionName) {
            // Update sidebar menu items
            const menuItems = document.querySelectorAll('.sidebar-menu-item');
            menuItems.forEach(item => item.classList.remove('active'));

            const currentEvent = window.event;
            if (currentEvent && currentEvent.target && typeof currentEvent.target.closest === 'function') {
                const menuItem = currentEvent.target.closest('.sidebar-menu-item');
                if (menuItem) {
                    menuItem.classList.add('active');
                }
            } else {
                const index = sectionName === 'sessions' ? 0 : sectionName === 'eventTypes' ? 1 : 2;
                if (menuItems[index]) {
                    menuItems[index].classList.add('active');
                }
            }

            // Update content sections
            const sections = document.querySelectorAll('.landing-section');
            sections.forEach(section => section.classList.remove('active'));

            // Show selected section
            if (sectionName === 'sessions') {
                document.getElementById('sessionsSection').classList.add('active');
            } else if (sectionName === 'eventTypes') {
                document.getElementById('eventTypesSection').classList.add('active');
            } else if (sectionName === 'settings') {
                document.getElementById('settingsSection').classList.add('active');
            }
        }

        function showTrackingView(sessionId) {
            currentSessionId = sessionId;
            document.getElementById('landingView').classList.remove('active');
            document.getElementById('trackingView').classList.add('active');

            const sessions = getSessions();
            const session = sessions.find(s => s.id === sessionId);
            if (session) {
                document.getElementById('sessionTitle').textContent = session.name;
            }

            // Activate the Tracker tab
            const tabsElement = document.querySelector('.tabs');
            if (tabsElement) {
                const tabInstance = M.Tabs.getInstance(tabsElement);
                if (tabInstance) {
                    tabInstance.select('eventsTab');
                }
            }

            renderEventButtons();
            displayEvents();
            loadTimelineSettings();

            if (getActiveEvents().length > 0) {
                startUpdateInterval();
            }
        }

        function backToLanding() {
            const activeEvents = getActiveEvents();

            if (activeEvents.length > 0) {
                const eventNames = activeEvents.map(e => e.type).join(', ');
                M.toast({
                    html: `<i class="material-icons left">warning</i>${t('warningActiveEvents')}`,
                    displayLength: 5000,
                    classes: 'orange darken-2'
                });
                return;
            }

            showLandingView();
        }

        function renderSessionList() {
            const sessions = getSessions();
            const tableBody = document.getElementById('sessionTableBody');
            const emptyMessage = document.getElementById('emptySessionsMessage');
            const table = tableBody.closest('table');

            if (sessions.length === 0) {
                table.style.display = 'none';
                emptyMessage.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyMessage.style.display = 'none';

            const rows = sessions.map(session => {
                const created = new Date(session.createdAt).toLocaleDateString();
                const modified = new Date(session.lastModified).toLocaleString();
                return `
                    <tr id="session-row-${session.id}" style="cursor: pointer;" onclick="openSession('${session.id}')">
                        <td style="font-weight: 500;">${session.name}</td>
                        <td>${created}</td>
                        <td>${modified}</td>
                        <td class="center-align">
                            <div id="actions-normal-${session.id}">
                                <button type="button" class="btn-small waves-effect waves-light blue"
                                        onclick="event.stopPropagation(); openSession('${session.id}')"
                                        style="margin-right: 5px;">
                                    <i class="material-icons">open_in_new</i>
                                </button>
                                <button type="button" class="btn-small waves-effect waves-light red"
                                        onclick="event.stopPropagation(); showDeleteConfirmation('${session.id}', '${session.name.replace(/'/g, "\\'")}')">
                                    <i class="material-icons">delete</i>
                                </button>
                            </div>
                            <div id="actions-confirm-${session.id}" style="display: none;">
                                <span style="color: #f44336; font-weight: 500; margin-right: 10px;">${t('deleteSession')} "${session.name}"?</span>
                                <button type="button" class="btn-small waves-effect waves-light red"
                                        onclick="event.stopPropagation(); confirmDeleteSession('${session.id}')">
                                    <i class="material-icons left">check</i>${t('delete')}
                                </button>
                                <button type="button" class="btn-small waves-effect waves-light grey"
                                        onclick="event.stopPropagation(); cancelDeleteSession('${session.id}')"
                                        style="margin-left: 5px;">
                                    <i class="material-icons left">close</i>${t('cancel')}
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        function createNewSession() {
            const modal = document.getElementById('newSessionModal');
            const input = document.getElementById('newSessionName');
            input.value = '';
            const instance = M.Modal.getInstance(modal);
            instance.open();
            setTimeout(() => {
                input.focus();
                M.updateTextFields();
            }, 100);
        }

        function confirmCreateSession() {
            const name = document.getElementById('newSessionName').value.trim();
            if (name) {
                const session = createSession(name);
                const modal = document.getElementById('newSessionModal');
                const instance = M.Modal.getInstance(modal);
                instance.close();
                openSession(session.id);
            } else {
                M.toast({html: 'Please enter a session name', displayLength: 2000});
            }
        }

        function openSession(sessionId) {
            showTrackingView(sessionId);
        }

        function showDeleteConfirmation(sessionId, sessionName) {
            document.getElementById(`actions-normal-${sessionId}`).style.display = 'none';
            document.getElementById(`actions-confirm-${sessionId}`).style.display = 'block';
            document.getElementById(`session-row-${sessionId}`).style.backgroundColor = '#ffebee';
        }

        function cancelDeleteSession(sessionId) {
            document.getElementById(`actions-normal-${sessionId}`).style.display = 'block';
            document.getElementById(`actions-confirm-${sessionId}`).style.display = 'none';
            document.getElementById(`session-row-${sessionId}`).style.backgroundColor = '';
        }

        function confirmDeleteSession(sessionId) {
            deleteSession(sessionId);
            renderSessionList();
            M.toast({html: '<i class="material-icons left">delete</i>Session deleted', displayLength: 2000});
        }

        function deleteSessionConfirm(sessionId) {
            showDeleteConfirmation(sessionId);
        }

        function renderGlobalEventTypes() {
            const eventTypes = getEventTypes();
            const container = document.getElementById('globalEventTypesList');

            if (eventTypes.length === 0) {
                container.innerHTML = '<p class="grey-text center-align" style="padding: 20px;">No event types yet. Click "Add Event Type" below to get started.</p>';
                return;
            }

            container.innerHTML = eventTypes.map((eventType, index) => {
                const isComplementary = eventType.isComplementary || false;
                const showingDeleteConfirm = deleteEventTypeIndex === index;

                if (showingDeleteConfirm) {
                    return `
                        <div class="card-panel red lighten-5" style="padding: 20px; margin-bottom: 15px; border-left: 4px solid #f44336;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <p style="margin: 0; font-weight: 500; color: #f44336;">
                                        <i class="material-icons" style="vertical-align: middle; font-size: 20px;">warning</i>
                                        <span data-i18n="delete">${t('delete')}</span> "${eventType.name}"?
                                    </p>
                                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;" data-i18n="thisActionCannotBeUndone">${t('thisActionCannotBeUndone')}</p>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn-small waves-effect waves-light grey" onclick="cancelDeleteEventType()" style="margin: 0;" data-i18n="cancel">
                                        ${t('cancel')}
                                    </button>
                                    <button class="btn-small waves-effect waves-light red" onclick="confirmDeleteEventType()" style="margin: 0;">
                                        <i class="material-icons left">delete</i><span data-i18n="delete">${t('delete')}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const complementaryColor = eventType.complementaryColor || eventType.color;

                return `
                    <div class="card-panel" style="padding: 20px; margin-bottom: 15px;">
                        <div class="row" style="margin-bottom: 0; display: flex; align-items: center; flex-wrap: wrap;">
                            <div class="col s12 m4 l3">
                                <label style="font-size: 12px; color: #9e9e9e; display: block; margin-bottom: 5px;" data-i18n="eventName">${t('eventName')}</label>
                                <input type="text"
                                       value="${eventType.name}"
                                       data-index="${index}"
                                       style="width: 100%; padding: 6px 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px; height: 32px; box-sizing: border-box;"
                                       onchange="updateGlobalEventTypeName(${index}, this.value)">
                            </div>
                            <div class="col s6 m2 l2">
                                <label style="font-size: 12px; color: #9e9e9e; display: block; margin-bottom: 5px;" data-i18n="color">${t('color')}</label>
                                <input type="color"
                                       value="${eventType.color}"
                                       data-index="${index}"
                                       style="width: 100%; height: 32px; border: 1px solid #e0e0e0; border-radius: 4px; cursor: pointer; padding: 2px; box-sizing: border-box;"
                                       onchange="updateGlobalEventTypeColor(${index}, this.value)">
                            </div>
                            <div class="col s12 m5 l4">
                                <label style="font-size: 12px; color: #9e9e9e; display: block; margin-bottom: 5px;">
                                    <input type="checkbox"
                                           class="filled-in"
                                           id="complementary-${index}"
                                           ${isComplementary ? 'checked' : ''}
                                           onchange="updateGlobalEventTypeComplementary(${index}, this.checked)">
                                    <span data-i18n="complementaryEvent">${t('complementaryEvent')}</span>
                                </label>
                                <p style="font-size: 11px; color: #9e9e9e; margin: 5px 0 0 0;" data-i18n-html="createsVariant">${t('createsVariant')} "${t('no')} ${eventType.name}"</p>
                            </div>
                            ${isComplementary ? `
                            <div class="col s6 m2 l2">
                                <label style="font-size: 12px; color: #9e9e9e; display: block; margin-bottom: 5px;" data-i18n="complementaryColor">${t('complementaryColor')}</label>
                                <input type="color"
                                       value="${complementaryColor}"
                                       data-index="${index}"
                                       style="width: 100%; height: 32px; border: 1px solid #e0e0e0; border-radius: 4px; cursor: pointer; padding: 2px; box-sizing: border-box;"
                                       onchange="updateGlobalEventTypeComplementaryColor(${index}, this.value)">
                            </div>
                            ` : ''}
                            <div class="col s6 m1 l1" style="text-align: center;">
                                <label style="font-size: 12px; color: transparent; display: block; margin-bottom: 5px;">.</label>
                                <button class="btn-small waves-effect waves-light red"
                                        onclick="showDeleteEventTypeConfirmation(${index})"
                                        style="margin: 0;">
                                    <i class="material-icons">delete</i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addGlobalEventType() {
            const eventTypes = getEventTypes();
            eventTypes.push({ name: 'New Event', color: '#999999', isComplementary: false });
            saveEventTypesToStorage(eventTypes);
            renderGlobalEventTypes();
        }

        function updateGlobalEventTypeName(index, newName) {
            const eventTypes = getEventTypes();
            if (eventTypes[index]) {
                eventTypes[index].name = newName;
                saveEventTypesToStorage(eventTypes);
                renderGlobalEventTypes();
                if (currentSessionId) {
                    renderEventButtons();
                }
            }
        }

        function updateGlobalEventTypeColor(index, newColor) {
            const eventTypes = getEventTypes();
            if (eventTypes[index]) {
                eventTypes[index].color = newColor;
                saveEventTypesToStorage(eventTypes);
            }
        }

        function updateGlobalEventTypeComplementary(index, isChecked) {
            const eventTypes = getEventTypes();
            if (eventTypes[index]) {
                eventTypes[index].isComplementary = isChecked;
                if (!isChecked) {
                    delete eventTypes[index].complementaryColor;
                }
                saveEventTypesToStorage(eventTypes);
                renderGlobalEventTypes();
                if (currentSessionId) {
                    renderEventButtons();
                    updateDynamicStyles(eventTypes);
                }
            }
        }

        function updateGlobalEventTypeComplementaryColor(index, color) {
            const eventTypes = getEventTypes();
            if (eventTypes[index]) {
                eventTypes[index].complementaryColor = color;
                saveEventTypesToStorage(eventTypes);
                renderGlobalEventTypes();
                if (currentSessionId) {
                    renderEventButtons();
                    updateDynamicStyles(eventTypes);
                }
            }
        }

        let deleteEventTypeIndex = null;

        function showDeleteEventTypeConfirmation(index) {
            deleteEventTypeIndex = index;
            renderGlobalEventTypes();
        }

        function cancelDeleteEventType() {
            deleteEventTypeIndex = null;
            renderGlobalEventTypes();
        }

        function confirmDeleteEventType() {
            if (deleteEventTypeIndex === null) return;

            const eventTypes = getEventTypes();
            eventTypes.splice(deleteEventTypeIndex, 1);
            saveEventTypesToStorage(eventTypes);
            deleteEventTypeIndex = null;
            renderGlobalEventTypes();
            if (currentSessionId) {
                renderEventButtons();
            }
        }

        function saveGlobalLanguage() {
            const language = document.getElementById('globalLanguageSetting').value;
            const settings = getGlobalSettings();
            settings.language = language;
            saveGlobalSettings(settings);
            showToast(t('languageUpdated'));
            updateUILanguage();
        }

        function saveGlobalTimeScale() {
            const timeScale = parseInt(document.getElementById('globalTimeScaleSetting').value);
            const settings = getGlobalSettings();
            settings.timeScale = timeScale;
            saveGlobalSettings(settings);
            showToast(t('timeScaleUpdated'));
        }

        function loadGlobalSettings() {
            const settings = getGlobalSettings();

            const langSelectElem = document.getElementById('globalLanguageSetting');
            langSelectElem.value = settings.language || 'en';
            var langInstance = M.FormSelect.getInstance(langSelectElem);
            if (langInstance) {
                langInstance.destroy();
            }
            M.FormSelect.init(langSelectElem);

            const selectElem = document.getElementById('globalTimeScaleSetting');
            selectElem.value = settings.timeScale || 1;
            var instance = M.FormSelect.getInstance(selectElem);
            if (instance) {
                instance.destroy();
            }
            M.FormSelect.init(selectElem);

            updateUILanguage();
        }

        function getComplementaryEvent(eventTypeName) {
            const eventTypes = getEventTypes();
            const noPrefix = `${t('no')} `;

            let eventType;
            let isNoVariant = false;

            if (eventTypeName.startsWith(noPrefix)) {
                const baseName = eventTypeName.substring(noPrefix.length);
                eventType = eventTypes.find(e => e.name === baseName);
                isNoVariant = true;
            } else {
                eventType = eventTypes.find(e => e.name === eventTypeName);
                isNoVariant = false;
            }

            if (!eventType || !eventType.isComplementary) return null;

            if (isNoVariant) {
                return eventType.name;
            } else {
                return `${noPrefix}${eventType.name}`;
            }
        }

        function toggleEvent(eventType) {
            let activeEvents = getActiveEvents();
            const activeEvent = activeEvents.find(e => e.type === eventType);

            if (activeEvent) {
                stopEvent(activeEvent.id);
            } else {
                startEvent(eventType);
            }
        }

        function startEvent(eventType) {
            let activeEvents = getActiveEvents();

            const complementaryEventName = getComplementaryEvent(eventType);
            if (complementaryEventName) {
                const complementaryActiveEvents = activeEvents.filter(e => e.type === complementaryEventName);
                complementaryActiveEvents.forEach(e => {
                    stopEvent(e.id, true);
                });
                activeEvents = getActiveEvents();
            }

            const event = {
                id: Date.now() + Math.random(),
                type: eventType,
                startTime: new Date().toISOString(),
                endTime: null
            };

            activeEvents.push(event);
            saveActiveEvents(activeEvents);

            renderEventButtons();
            const complementaryMsg = complementaryEventName ? ` (stopped ${complementaryEventName})` : '';
            showToast(`${eventType} started!${complementaryMsg}`);
            startUpdateInterval();
        }

        function stopEvent(eventId, silent = false) {
            let activeEvents = getActiveEvents();
            const eventIndex = activeEvents.findIndex(e => e.id === eventId);

            if (eventIndex !== -1) {
                const event = activeEvents[eventIndex];
                event.endTime = new Date().toISOString();

                const startTime = new Date(event.startTime);
                const endTime = new Date(event.endTime);
                event.duration = Math.floor((endTime - startTime) / 1000);

                let events = getEvents();
                events.push(event);
                saveEvents(events);

                activeEvents.splice(eventIndex, 1);
                saveActiveEvents(activeEvents);

                if (!silent) {
                    renderEventButtons();
                    displayEvents();
                    showToast(`${event.type} stopped! Duration: ${formatDuration(event.duration)}`);
                }

                if (activeEvents.length === 0) {
                    stopUpdateInterval();
                }
            }
        }

        function getEvents() {
            if (!currentSessionId) return [];
            const stored = localStorage.getItem(getSessionStorageKey('events'));
            return stored ? JSON.parse(stored) : [];
        }

        function saveEvents(events) {
            if (!currentSessionId) return;
            localStorage.setItem(getSessionStorageKey('events'), JSON.stringify(events));
            updateSessionTimestamp(currentSessionId);
        }

        function getActiveEvents() {
            if (!currentSessionId) return [];
            const stored = localStorage.getItem(getSessionStorageKey('activeEvents'));
            return stored ? JSON.parse(stored) : [];
        }

        function saveActiveEvents(activeEvents) {
            if (!currentSessionId) return;
            localStorage.setItem(getSessionStorageKey('activeEvents'), JSON.stringify(activeEvents));
            updateSessionTimestamp(currentSessionId);
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function calculateDuration(startTime) {
            const start = new Date(startTime);
            const now = new Date();
            return Math.floor((now - start) / 1000);
        }

        function getEventTypes() {
            const settings = getGlobalSettings();
            return settings.eventTypes || DEFAULT_EVENT_TYPES;
        }

        function saveEventTypesToStorage(eventTypes) {
            const settings = getGlobalSettings();
            settings.eventTypes = eventTypes;
            saveGlobalSettings(settings);
        }

        function getSettings() {
            const globalSettings = getGlobalSettings();
            if (!currentSessionId) {
                return {
                    timeScale: globalSettings.timeScale || 1,
                    timelineDate: new Date().toISOString().split('T')[0],
                    timelineView: 'range',
                    timelineEndDate: new Date().toISOString().split('T')[0]
                };
            }
            const stored = localStorage.getItem(getSessionStorageKey('settings'));
            const sessionSettings = stored ? JSON.parse(stored) : {
                timelineDate: new Date().toISOString().split('T')[0],
                timelineView: 'range',
                timelineEndDate: new Date().toISOString().split('T')[0]
            };
            return {
                timeScale: globalSettings.timeScale || 1,
                ...sessionSettings
            };
        }

        function saveTimelineSettings() {
            if (!currentSessionId) return;
            const settings = getSettings();
            settings.timelineDate = document.getElementById('timelineDate').value;
            settings.timelineView = document.getElementById('timelineView').value;
            settings.timelineEndDate = document.getElementById('timelineEndDate').value;
            const sessionSettings = {
                timelineDate: settings.timelineDate,
                timelineView: settings.timelineView,
                timelineEndDate: settings.timelineEndDate
            };
            localStorage.setItem(getSessionStorageKey('settings'), JSON.stringify(sessionSettings));
        }

        function loadTimelineSettings() {
            const settings = getSettings();
            const events = getEvents();

            let startDate = settings.timelineDate;
            let endDate = settings.timelineEndDate;
            let viewMode = settings.timelineView || 'range';
            let displayText = 'Showing all events';

            if (events.length > 0) {
                const eventDates = events.map(e => new Date(e.startTime || e.timestamp));
                const minDate = new Date(Math.min(...eventDates));
                const maxDate = new Date(Math.max(...eventDates));

                startDate = minDate.toISOString().split('T')[0];
                endDate = maxDate.toISOString().split('T')[0];

                if (minDate.toDateString() !== maxDate.toDateString()) {
                    viewMode = 'range';
                }

                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);

                if (startDate === endDate) {
                    displayText = `(${startDateObj.toLocaleDateString()})`;
                } else {
                    displayText = `(${startDateObj.toLocaleDateString()} - ${endDateObj.toLocaleDateString()})`;
                }
            } else {
                displayText = '(No events)';
            }

            document.getElementById('timelineDate').value = startDate;
            document.getElementById('timelineView').value = viewMode;
            document.getElementById('timelineEndDate').value = endDate;

            const rangeDisplay = document.getElementById('timelineRangeDisplay');
            if (rangeDisplay) {
                rangeDisplay.textContent = displayText;
            }
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'timeline') {
                loadTimelineSettings();
                generateTimeline();
            }
        }



        function getEventTypeClass(name) {
            return name.toLowerCase().replace(/\s+/g, '-');
        }

        function renderEventButtons() {
            const activeEvents = getActiveEvents();
            const eventTypes = getEventTypes();
            const container = document.getElementById('eventButtons');

            if (!currentSessionId) {
                container.innerHTML = '<div class="empty-state">No session selected.</div>';
                return;
            }

            if (eventTypes.length === 0) {
                container.innerHTML = '<div class="empty-state">No event types defined. Return to the landing page to add event types in Global Settings.</div>';
                return;
            }

            updateDynamicStyles(eventTypes);

            const buttons = [];

            eventTypes.forEach(eventType => {
                const eventNames = eventType.isComplementary
                    ? [eventType.name, `${t('no')} ${eventType.name}`]
                    : [eventType.name];

                eventNames.forEach(eventName => {
                    const activeInstances = activeEvents.filter(e => e.type === eventName);
                    const isActive = activeInstances.length > 0;
                    const instanceCount = activeInstances.length;
                    const eventClass = getEventTypeClass(eventName);

                    let statusDisplay = t('clickToStart');
                    let icon = 'play_arrow';

                    if (isActive) {
                        const oldestEvent = activeInstances[0];
                        const duration = calculateDuration(oldestEvent.startTime);
                        const formattedDuration = formatDuration(duration);
                        statusDisplay = `${t('running')} (<span id="btn-duration-${eventClass}">${formattedDuration}</span>)`;
                        icon = 'stop';
                    }

                    const instanceBadge = instanceCount > 1 ? `<span class="new badge" data-badge-caption="">${instanceCount}</span>` : '';

                    buttons.push(`
                        <button class="btn-large waves-effect waves-light event-btn ${eventClass} ${isActive ? 'active' : ''}"
                                onclick="toggleEvent('${eventName.replace(/'/g, "\\'")}')"
                                style="width: 100%; margin-bottom: 15px; position: relative; text-align: left; display: flex; flex-direction: column; align-items: flex-start; padding: 20px;">
                            ${instanceBadge}
                            <div class="event-btn-label" style="display: flex; align-items: center; font-size: 18px; font-weight: 500;">
                                <i class="material-icons left">${icon}</i>${eventName}
                            </div>
                            <div class="event-btn-status" style="font-size: 14px; opacity: 0.9; margin-top: 5px;">${statusDisplay}</div>
                        </button>
                    `);
                });
            });

            container.innerHTML = buttons.join('');
        }

        function updateDynamicStyles(eventTypes) {
            let styleElement = document.getElementById('dynamic-event-styles');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'dynamic-event-styles';
                document.head.appendChild(styleElement);
            }

            const styles = [];
            eventTypes.forEach(eventType => {
                const eventNames = eventType.isComplementary
                    ? [eventType.name, `${t('no')} ${eventType.name}`]
                    : [eventType.name];

                eventNames.forEach(eventName => {
                    const eventClass = getEventTypeClass(eventName);
                    const color = eventName.startsWith(`${t('no')} `)
                        ? (eventType.complementaryColor || eventType.color)
                        : eventType.color;
                    styles.push(`.event-btn.${eventClass} { background: ${color}; }`);
                });
            });

            styleElement.textContent = styles.join('\n');
        }

        function displayEvents() {
            const tableBody = document.getElementById('eventsTableBody');
            const emptyMessage = document.getElementById('emptyEventsMessage');
            const table = tableBody.closest('table');

            if (!currentSessionId) {
                table.style.display = 'none';
                emptyMessage.style.display = 'block';
                emptyMessage.querySelector('p').textContent = 'No session selected';
                return;
            }

            const events = getEvents();

            if (events.length === 0) {
                table.style.display = 'none';
                emptyMessage.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyMessage.style.display = 'none';

            const sortedEvents = events.sort((a, b) => {
                const timeA = new Date(a.startTime || a.timestamp);
                const timeB = new Date(b.startTime || b.timestamp);
                return timeB - timeA;
            });

            const eventColors = getEventColors();
            tableBody.innerHTML = sortedEvents.map(event => {
                const color = eventColors[event.type] || '#999';
                const startTime = new Date(event.startTime).toLocaleString();
                const endTime = event.endTime ? new Date(event.endTime).toLocaleString() : 'N/A';
                const duration = event.duration ? formatDuration(event.duration) : 'N/A';
                const showingDeleteConfirm = deleteEventId === event.id;

                if (showingDeleteConfirm) {
                    return `
                        <tr style="background-color: #ffebee;">
                            <td colspan="5" style="padding: 15px;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <p style="margin: 0; font-weight: 500; color: #f44336;">
                                            <i class="material-icons" style="vertical-align: middle; font-size: 20px;">warning</i>
                                            <span data-i18n="delete">${t('delete')}</span> this event?
                                        </p>
                                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;" data-i18n="thisActionCannotBeUndone">${t('thisActionCannotBeUndone')}</p>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn-small waves-effect waves-light grey" onclick="cancelDeleteEvent()" data-i18n="cancel">
                                            ${t('cancel')}
                                        </button>
                                        <button class="btn-small waves-effect waves-light red" onclick="confirmDeleteEvent()">
                                            <i class="material-icons left">delete</i><span data-i18n="delete">${t('delete')}</span>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }

                return `
                    <tr>
                        <td>
                            <span style="display: inline-block; width: 12px; height: 12px; background-color: ${color}; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>
                            <span style="font-weight: 500;">${event.type}</span>
                        </td>
                        <td>${startTime}</td>
                        <td>${endTime}</td>
                        <td>${duration}</td>
                        <td class="center-align">
                            <button type="button" class="btn-small waves-effect waves-light red"
                                    onclick="showDeleteEventConfirmation('${event.id}')">
                                <i class="material-icons">delete</i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function startUpdateInterval() {
            if (updateInterval) return;

            updateInterval = setInterval(() => {
                const activeEvents = getActiveEvents();
                if (activeEvents.length === 0) {
                    stopUpdateInterval();
                    return;
                }

                const eventTypes = getEventTypes();
                eventTypes.forEach(eventType => {
                    const eventNames = eventType.isComplementary
                        ? [eventType.name, `${t('no')} ${eventType.name}`]
                        : [eventType.name];

                    eventNames.forEach(eventName => {
                        const activeInstances = activeEvents.filter(e => e.type === eventName);
                        if (activeInstances.length > 0) {
                            const oldestEvent = activeInstances[0];
                            const duration = calculateDuration(oldestEvent.startTime);
                            const eventClass = getEventTypeClass(eventName);
                            const durationElement = document.getElementById(`btn-duration-${eventClass}`);
                            if (durationElement) {
                                durationElement.textContent = formatDuration(duration);
                            }
                        }
                    });
                });

                displayEvents();
            }, 1000);
        }

        function stopUpdateInterval() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        function exportCSV() {
            const events = getEvents();
            const activeEvents = getActiveEvents();

            if (events.length === 0 && activeEvents.length === 0) {
                showToast(t('noEventsToDisplay'));
                return;
            }

            const allEvents = [...events];
            activeEvents.forEach(active => {
                allEvents.push({
                    ...active,
                    endTime: new Date().toISOString(),
                    duration: calculateDuration(active.startTime),
                    isActive: true
                });
            });

            const sortedEvents = allEvents.sort((a, b) => {
                const timeA = new Date(a.startTime || a.timestamp);
                const timeB = new Date(b.startTime || b.timestamp);
                return timeA - timeB;
            });

            let csvContent = 'Event Type,Start Time,End Time,Duration (seconds),Status\n';

            sortedEvents.forEach(event => {
                const escapedType = `"${event.type.replace(/"/g, '""')}"`;
                const startTime = event.startTime || event.timestamp;
                const endTime = event.endTime || '';
                const duration = event.duration || 0;
                const status = event.isActive ? 'RUNNING' : 'COMPLETED';
                csvContent += `${escapedType},${startTime},${endTime},${duration},${status}\n`;
            });

            const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `events_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            showToast(t('csvExported'));
        }

        let deleteEventId = null;

        function showDeleteEventConfirmation(eventId) {
            deleteEventId = Number(eventId);
            displayEvents();
        }

        function cancelDeleteEvent() {
            deleteEventId = null;
            displayEvents();
        }

        function confirmDeleteEvent() {
            if (!currentSessionId || deleteEventId === null) return;

            const events = getEvents();
            const updatedEvents = events.filter(e => e.id !== deleteEventId);
            localStorage.setItem(getSessionStorageKey('events'), JSON.stringify(updatedEvents));
            deleteEventId = null;
            displayEvents();
            generateTimeline();
            updateSessionTimestamp(currentSessionId);
            M.toast({html: 'Event deleted', displayLength: 2000});
        }

        function showResetConfirmationModal() {
            const resetModal = M.Modal.getInstance(document.getElementById('resetConfirmModal'));
            if (resetModal) resetModal.open();
        }

        function confirmResetEventsModal() {
            if (!currentSessionId) return;
            localStorage.removeItem(getSessionStorageKey('events'));
            localStorage.removeItem(getSessionStorageKey('activeEvents'));
            localStorage.removeItem(getSessionStorageKey('settings'));
            stopUpdateInterval();
            renderEventButtons();
            displayEvents();
            clearTimeline();
            updateSessionTimestamp(currentSessionId);
            M.toast({html: '<i class="material-icons left">delete_forever</i>' + t('allEventsReset'), displayLength: 2000});

            const resetModal = M.Modal.getInstance(document.getElementById('resetConfirmModal'));
            if (resetModal) resetModal.close();
        }

        function clearTimeline() {
            const canvas = document.getElementById('timelineCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function showToast(message) {
            M.toast({html: message, displayLength: 2000});
        }

        function getEventColors() {
            const eventTypes = getEventTypes();
            const colors = {};
            eventTypes.forEach(eventType => {
                colors[eventType.name] = eventType.color;
                if (eventType.isComplementary) {
                    const compColor = eventType.complementaryColor || eventType.color;
                    colors[`${t('no')} ${eventType.name}`] = compColor;
                    colors[`No ${eventType.name}`] = compColor;
                    colors[`Sans ${eventType.name}`] = compColor;
                }
            });
            return colors;
        }

        function toggleTimeline() {
            switchTab('timeline');
        }

        function generateTimeline() {
            const events = getEvents();
            const activeEvents = getActiveEvents();

            const allEvents = [...events];
            activeEvents.forEach(active => {
                allEvents.push({
                    ...active,
                    endTime: new Date().toISOString(),
                    duration: calculateDuration(active.startTime),
                    isActive: true
                });
            });

            console.log('All events combined:', allEvents);

            if (allEvents.length === 0) {
                console.log('No events to display');
                showToast(t('noEventsToDisplay'));
                return;
            }

            const viewType = document.getElementById('timelineView').value;
            const dateInput = document.getElementById('timelineDate');
            const endDateInput = document.getElementById('timelineEndDate');

            const canvas = document.getElementById('timelineCanvas');
            const ctx = canvas.getContext('2d');

            const dpr = window.devicePixelRatio || 1;
            const canvasContainer = canvas.parentElement;
            const containerWidth = canvasContainer.offsetWidth;
            const canvasWidth = containerWidth > 0 ? containerWidth : 800;

            // Calculate available viewport height for timeline
            const viewportHeight = window.innerHeight;
            const trackingView = document.getElementById('trackingView');
            const navBar = trackingView.querySelector('div[style*="background: #7c3aed"]');
            const tabs = trackingView.querySelector('.tabs');

            // Calculate heights of fixed elements
            const navBarHeight = navBar ? navBar.offsetHeight : 0;
            const tabsHeight = tabs ? tabs.offsetHeight : 0;
            const padding = 60; // Top/bottom padding of container + margins

            // Calculate available height for canvas
            const availableHeight = viewportHeight - navBarHeight - tabsHeight - padding;
            const canvasHeight = Math.max(400, Math.min(availableHeight, 800)); // Min 400px, max 800px

            canvas.width = canvasWidth * dpr;
            canvas.height = canvasHeight * dpr;
            canvas.style.width = '100%';
            canvas.style.height = canvasHeight + 'px';
            ctx.scale(dpr, dpr);

            const width = canvasWidth;
            const height = canvasHeight;
            const leftPadding = 150;
            const rightPadding = 60;
            const topBottomPadding = 20;
            const chartHeight = height - topBottomPadding * 2;

            ctx.clearRect(0, 0, width, height);

            let filteredEvents;
            let startTime, endTime;

            if (viewType === 'day') {
                const selectedDate = new Date(dateInput.value + 'T00:00:00');
                const dayStart = new Date(selectedDate);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(selectedDate);
                dayEnd.setHours(23, 59, 59, 999);

                filteredEvents = allEvents.filter(e => {
                    const eventTime = new Date(e.startTime || e.timestamp);
                    return eventTime >= dayStart && eventTime <= dayEnd;
                });
            } else {
                const startDate = new Date(dateInput.value + 'T00:00:00');
                const endDate = new Date(endDateInput.value + 'T00:00:00');
                const rangeStart = new Date(startDate);
                rangeStart.setHours(0, 0, 0, 0);
                const rangeEnd = new Date(endDate);
                rangeEnd.setHours(23, 59, 59, 999);

                filteredEvents = allEvents.filter(e => {
                    const eventTime = new Date(e.startTime || e.timestamp);
                    return eventTime >= rangeStart && eventTime <= rangeEnd;
                });
            }

            if (filteredEvents.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No events found for selected date/range', width / 2, height / 2);
                return;
            }

            filteredEvents.sort((a, b) => {
                const timeA = new Date(a.startTime || a.timestamp);
                const timeB = new Date(b.startTime || b.timestamp);
                return timeA - timeB;
            });

            const eventTimes = [];
            filteredEvents.forEach(e => {
                eventTimes.push(new Date(e.startTime || e.timestamp).getTime());
                if (e.endTime) {
                    eventTimes.push(new Date(e.endTime).getTime());
                }
            });

            const minEventTime = Math.min(...eventTimes);
            const maxEventTime = Math.max(...eventTimes);

            const settings = getSettings();
            const timeScale = settings.timeScale;
            const buffer = (maxEventTime - minEventTime) * 0.1;

            startTime = new Date(minEventTime - buffer);
            endTime = new Date(maxEventTime + buffer);

            drawTimeline(ctx, filteredEvents, startTime, endTime, width, height, leftPadding, rightPadding, topBottomPadding, chartHeight, viewType);
        }

        let timelineEventRects = [];

        function drawTimeline(ctx, events, startTime, endTime, width, height, leftPadding, rightPadding, topBottomPadding, chartHeight, viewType) {
            timelineEventRects = [];
            const settings = getSettings();
            const timeScale = settings.timeScale;
            const actualTimeRange = endTime - startTime;
            const scaledTimeRange = actualTimeRange / timeScale;
            const chartWidth = width - leftPadding - rightPadding;

            const chartTop = topBottomPadding;
            ctx.fillStyle = '#f3f4f6';
            ctx.fillRect(leftPadding, chartTop, chartWidth, chartHeight);

            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(leftPadding, chartTop);
            ctx.lineTo(leftPadding, chartTop + chartHeight);
            ctx.lineTo(leftPadding + chartWidth, chartTop + chartHeight);
            ctx.stroke();

            const scaledRangeMs = scaledTimeRange * 1000;
            let numTicks, tickInterval;

            if (scaledRangeMs < 60000) {
                numTicks = 10;
                tickInterval = scaledRangeMs / numTicks;
            } else if (scaledRangeMs < 3600000) {
                numTicks = Math.min(12, Math.ceil(scaledRangeMs / 60000));
                tickInterval = scaledRangeMs / numTicks;
            } else if (scaledRangeMs < 86400000) {
                numTicks = Math.min(24, Math.ceil(scaledRangeMs / 3600000));
                tickInterval = scaledRangeMs / numTicks;
            } else {
                numTicks = Math.min(10, Math.ceil(scaledRangeMs / 86400000));
                tickInterval = scaledRangeMs / numTicks;
            }

            for (let i = 0; i <= numTicks; i++) {
                const x = leftPadding + (chartWidth * i / numTicks);
                const actualTickTime = startTime.getTime() + (actualTimeRange * i / numTicks);
                const tickTime = new Date(actualTickTime);

                ctx.strokeStyle = '#e5e7eb';
                ctx.beginPath();
                ctx.moveTo(x, chartTop);
                ctx.lineTo(x, chartTop + chartHeight);
                ctx.stroke();

                ctx.fillStyle = '#666';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'center';

                let label;
                if (scaledRangeMs < 60000) {
                    label = tickTime.getSeconds() + 's';
                } else if (scaledRangeMs < 3600000) {
                    label = tickTime.getHours() + ':' + String(tickTime.getMinutes()).padStart(2, '0');
                } else if (scaledRangeMs < 86400000) {
                    label = tickTime.getHours() + ':' + String(tickTime.getMinutes()).padStart(2, '0');
                } else {
                    label = (tickTime.getMonth() + 1) + '/' + tickTime.getDate() + ' ' + tickTime.getHours() + ':' + String(tickTime.getMinutes()).padStart(2, '0');
                }

                ctx.fillText(label, x, chartTop + chartHeight + 20);
            }

            // Group complementary events together
            const eventTypes = [...new Set(events.map(e => e.type))];
            const globalEventTypes = getEventTypes();
            const noPrefix = `${t('no')} `;

            // Create ordered list of event type rows, grouping complementary pairs
            const eventTypeRows = [];
            const processedTypes = new Set();

            eventTypes.forEach(type => {
                if (processedTypes.has(type)) return;

                // Check if this is a "No" variant
                let baseType = type;
                let isNoVariant = false;
                if (type.startsWith(noPrefix)) {
                    baseType = type.substring(noPrefix.length);
                    isNoVariant = true;
                }

                // Find the global event type definition
                const globalType = globalEventTypes.find(et => et.name === baseType);

                if (globalType && globalType.isComplementary) {
                    // Add both the base and "No" variant in order
                    const baseEventName = globalType.name;
                    const noEventName = `${noPrefix}${globalType.name}`;

                    if (eventTypes.includes(baseEventName)) {
                        eventTypeRows.push(baseEventName);
                        processedTypes.add(baseEventName);
                    }
                    if (eventTypes.includes(noEventName)) {
                        eventTypeRows.push(noEventName);
                        processedTypes.add(noEventName);
                    }
                } else {
                    // Non-complementary event, just add it
                    eventTypeRows.push(type);
                    processedTypes.add(type);
                }
            });

            const totalRows = eventTypeRows.length;

            // Calculate row height to distribute events evenly and center them
            const minRowHeight = 35;
            const maxRowHeight = 60;
            const idealRowHeight = chartHeight / totalRows;
            const actualRowHeight = Math.max(minRowHeight, Math.min(maxRowHeight, idealRowHeight));

            // Calculate total height needed for all rows
            const totalContentHeight = actualRowHeight * totalRows;

            // Calculate vertical offset to center the content
            const verticalOffset = (chartHeight - totalContentHeight) / 2;

            eventTypeRows.forEach((type, index) => {
                const y = chartTop + verticalOffset + (index * actualRowHeight);

                ctx.fillStyle = '#fff';
                ctx.fillRect(0, y, leftPadding - 5, actualRowHeight - 2);

                ctx.fillStyle = '#333';
                ctx.font = 'bold 13px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(type, leftPadding - 10, y + actualRowHeight / 2 + 5);
            });

            events.forEach(event => {
                const eventStartTime = new Date(event.startTime || event.timestamp);
                const eventEndTime = event.endTime ? new Date(event.endTime) : eventStartTime;

                const scaledStartTime = (eventStartTime - startTime) / timeScale;
                const scaledEndTime = (eventEndTime - startTime) / timeScale;

                const x1 = leftPadding + (scaledStartTime / scaledTimeRange) * chartWidth;
                const x2 = leftPadding + (scaledEndTime / scaledTimeRange) * chartWidth;

                const typeIndex = eventTypeRows.indexOf(event.type);
                const y = chartTop + verticalOffset + (typeIndex * actualRowHeight);
                const barHeight = actualRowHeight - 10;

                const eventColors = getEventColors();
                const color = eventColors[event.type] || '#999';

                if (event.endTime && event.startTime !== event.endTime) {
                    const rectX = x1;
                    const rectY = y + 5;
                    const rectWidth = Math.max(x2 - x1, 2);
                    const rectHeight = barHeight;

                    ctx.fillStyle = color;
                    ctx.globalAlpha = event.isActive ? 0.7 : 0.5;
                    ctx.fillRect(rectX, rectY, rectWidth, rectHeight);
                    ctx.globalAlpha = 1;

                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(rectX, rectY, rectWidth, rectHeight);

                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(x1, y + actualRowHeight / 2, 5, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.beginPath();
                    ctx.arc(x2, y + actualRowHeight / 2, 5, 0, Math.PI * 2);
                    ctx.fill();

                    timelineEventRects.push({
                        x: rectX,
                        y: rectY,
                        width: rectWidth,
                        height: rectHeight,
                        event: event
                    });
                } else {
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(x1, y + actualRowHeight / 2, 6, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    timelineEventRects.push({
                        x: x1 - 6,
                        y: y + actualRowHeight / 2 - 6,
                        width: 12,
                        height: 12,
                        event: event
                    });
                }
            });
        }



        function downloadTimeline() {
            const canvas = document.getElementById('timelineCanvas');
            const link = document.createElement('a');
            const dateStr = document.getElementById('timelineDate').value;
            link.download = `timeline_${dateStr}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast(t('timelineDownloaded'));
        }

        document.getElementById('timelineView').addEventListener('change', function() {
            if (this.value === 'range') {
                document.getElementById('timelineEndDate').style.display = 'inline-block';
            } else {
                document.getElementById('timelineEndDate').style.display = 'none';
            }
        });

        const canvas = document.getElementById('timelineCanvas');
        const tooltip = document.getElementById('timelineTooltip');

        canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            let found = false;
            for (const eventRect of timelineEventRects) {
                if (x >= eventRect.x && x <= eventRect.x + eventRect.width &&
                    y >= eventRect.y && y <= eventRect.y + eventRect.height) {

                    const event = eventRect.event;
                    const startTime = new Date(event.startTime || event.timestamp);
                    const endTime = event.endTime ? new Date(event.endTime) : null;

                    let tooltipText = `<strong>${event.type}</strong><br>`;
                    tooltipText += `Start: ${startTime.toLocaleString()}<br>`;
                    if (endTime) {
                        tooltipText += `End: ${endTime.toLocaleString()}<br>`;
                        tooltipText += `Duration: ${formatDuration(event.duration)}`;
                    }

                    tooltip.innerHTML = tooltipText;
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.pageX + 15) + 'px';
                    tooltip.style.top = (e.pageY + 15) + 'px';

                    found = true;
                    break;
                }
            }

            if (!found) {
                tooltip.style.display = 'none';
            }
        });

        canvas.addEventListener('mouseleave', function() {
            tooltip.style.display = 'none';
        });

    </script>

    <!-- Materialize JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        // Initialize app after Materialize is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Materialize components
            var elems = document.querySelectorAll('.tabs');
            var tabInstances = M.Tabs.init(elems, {
                onShow: function(tab) {
                    if (tab.id === 'timelineTab') {
                        loadTimelineSettings();
                        generateTimeline();
                    }
                }
            });

            var selects = document.querySelectorAll('select:not(.browser-default)');
            M.FormSelect.init(selects);

            var modals = document.querySelectorAll('.modal');
            M.Modal.init(modals);

            var dropdowns = document.querySelectorAll('.dropdown-trigger');
            M.Dropdown.init(dropdowns, {
                coverTrigger: false,
                constrainWidth: false
            });

            // Update UI language on page load
            updateUILanguage();

            // Show landing view
            showLandingView();
        });
    </script>
</body>
</html>
